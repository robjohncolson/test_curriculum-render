<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Stats Teacher Dashboard</title>

    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase_config.js"></script>

    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--bg-secondary, #f5f5f5);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color, #3498db);
        }

        .stat-label {
            color: var(--text-secondary, #666);
            margin-top: 5px;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        .student-table th,
        .student-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #ddd);
        }

        .student-table th {
            background: var(--bg-secondary, #f5f5f5);
            font-weight: bold;
        }

        .student-table tr:hover {
            background: var(--bg-hover, #f9f9f9);
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .question-card {
            background: white;
            border: 1px solid var(--border-color, #ddd);
            border-radius: 8px;
            padding: 15px;
        }

        .question-card h4 {
            margin-top: 0;
            color: var(--primary-color, #3498db);
        }

        .answer-distribution {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .answer-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-bar-fill {
            height: 20px;
            background: var(--primary-color, #3498db);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .refresh-button {
            background: var(--primary-color, #3498db);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .refresh-button:hover {
            background: var(--primary-hover, #2980b9);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background: #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        .filter-controls {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .filter-controls select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color, #ddd);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>üìä AP Statistics Teacher Dashboard</h1>

        <div id="connectionStatus" style="margin: 10px 0;">
            <span class="status-indicator status-offline"></span>
            <span id="statusText">Connecting to database...</span>
        </div>

        <div id="lastUpdate" style="margin: 10px 0; color: var(--text-secondary, #666);">
            Last updated: <span id="updateTime">Never</span>
        </div>

        <button class="refresh-button" onclick="refreshData()">üîÑ Refresh Data</button>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAnswers">0</div>
                <div class="stat-label">Total Answers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgProgress">0%</div>
                <div class="stat-label">Average Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeToday">0</div>
                <div class="stat-label">Active Today</div>
            </div>
        </div>

        <div class="filter-controls">
            <label>
                Filter by Unit:
                <select id="unitFilter" onchange="filterData()">
                    <option value="">All Units</option>
                </select>
            </label>
            <label>
                Filter by Lesson:
                <select id="lessonFilter" onchange="filterData()">
                    <option value="">All Lessons</option>
                </select>
            </label>
        </div>

        <h2>Student Progress</h2>
        <table class="student-table" id="studentTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Questions Answered</th>
                    <th>Last Activity</th>
                    <th>Progress</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <!-- Students will be added here -->
            </tbody>
        </table>

        <h2>Question Response Distribution</h2>
        <div class="question-grid" id="questionGrid">
            <!-- Question cards will be added here -->
        </div>
    </div>

    <script src="data/curriculum.js"></script>
    <script src="data/units.js"></script>
    <script>
        // Initialize Supabase client
        let supabase = null;
        let allData = [];
        let filteredData = [];

        // Initialize Supabase if credentials are provided
        if (typeof SUPABASE_URL !== 'undefined' && SUPABASE_URL !== 'YOUR_SUPABASE_PROJECT_URL' &&
            typeof SUPABASE_ANON_KEY !== 'undefined' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('üöÄ Supabase client initialized for dashboard');
            } catch (error) {
                console.error('‚ùå Failed to initialize Supabase:', error);
                updateConnectionStatus(false);
            }
        } else {
            console.error('‚ùå Supabase config not set');
            updateConnectionStatus(false);
            document.getElementById('statusText').textContent = 'Supabase configuration missing';
        }

        // Update connection status indicator
        function updateConnectionStatus(isConnected) {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');

            if (isConnected) {
                indicator.className = 'status-indicator status-online';
                statusText.textContent = 'Connected to database';
            } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Disconnected from database';
            }
        }

        // Format timestamp for display
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';

            const date = new Date(parseInt(timestamp));
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} days ago`;

            return date.toLocaleDateString();
        }

        // Load data from Supabase
        async function loadData() {
            if (!supabase) {
                console.error('Supabase not initialized');
                updateConnectionStatus(false);
                return;
            }

            try {
                // Fetch all answers
                const { data, error } = await supabase
                    .from('answers')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (error) throw error;

                allData = data || [];
                updateConnectionStatus(true);

                // Update last refresh time
                document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();

                // Process and display data
                processData();

            } catch (error) {
                console.error('Error loading data:', error);
                updateConnectionStatus(false);
            }
        }

        // Process the loaded data
        function processData() {
            if (!allData || allData.length === 0) {
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('totalAnswers').textContent = '0';
                document.getElementById('avgProgress').textContent = '0%';
                document.getElementById('activeToday').textContent = '0';
                document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="4">No data available</td></tr>';
                document.getElementById('questionGrid').innerHTML = '<p>No questions answered yet</p>';
                return;
            }

            // Calculate statistics
            const uniqueStudents = new Set(allData.map(a => a.username));
            const totalStudents = uniqueStudents.size;
            const totalAnswers = allData.length;

            // Group by student
            const studentData = {};
            allData.forEach(answer => {
                if (!studentData[answer.username]) {
                    studentData[answer.username] = {
                        answers: [],
                        lastActivity: 0
                    };
                }
                studentData[answer.username].answers.push(answer);
                studentData[answer.username].lastActivity = Math.max(
                    studentData[answer.username].lastActivity,
                    parseInt(answer.timestamp)
                );
            });

            // Calculate active today
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const todayTimestamp = todayStart.getTime();
            const activeToday = Object.values(studentData).filter(
                s => s.lastActivity >= todayTimestamp
            ).length;

            // Calculate average progress (assuming ~100 total questions in curriculum)
            const totalQuestions = Object.keys(curriculumData || {}).length || 100;
            const avgAnswersPerStudent = totalAnswers / totalStudents;
            const avgProgress = Math.round((avgAnswersPerStudent / totalQuestions) * 100);

            // Update statistics display
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalAnswers').textContent = totalAnswers;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
            document.getElementById('activeToday').textContent = activeToday;

            // Update student table
            updateStudentTable(studentData);

            // Update question distribution
            updateQuestionDistribution();

            // Populate filters
            populateFilters();
        }

        // Update student table
        function updateStudentTable(studentData) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            // Sort students by last activity
            const sortedStudents = Object.entries(studentData)
                .sort((a, b) => b[1].lastActivity - a[1].lastActivity);

            sortedStudents.forEach(([username, data]) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = username;
                row.insertCell(1).textContent = data.answers.length;
                row.insertCell(2).textContent = formatTimestamp(data.lastActivity);

                // Progress bar
                const totalQuestions = Object.keys(curriculumData || {}).length || 100;
                const progress = Math.round((data.answers.length / totalQuestions) * 100);
                const progressCell = row.insertCell(3);
                progressCell.innerHTML = `
                    <div style="width: 100%; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${progress}%; background: #3498db; height: 20px; text-align: center; color: white;">
                            ${progress}%
                        </div>
                    </div>
                `;
            });
        }

        // Update question distribution display
        function updateQuestionDistribution() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';

            // Group answers by question
            const questionGroups = {};
            allData.forEach(answer => {
                if (!questionGroups[answer.question_id]) {
                    questionGroups[answer.question_id] = {};
                }
                if (!questionGroups[answer.question_id][answer.answer_value]) {
                    questionGroups[answer.question_id][answer.answer_value] = 0;
                }
                questionGroups[answer.question_id][answer.answer_value]++;
            });

            // Create cards for each question
            Object.entries(questionGroups).forEach(([questionId, answers]) => {
                const card = document.createElement('div');
                card.className = 'question-card';

                const totalResponses = Object.values(answers).reduce((sum, count) => sum + count, 0);

                // Get question info from curriculum if available
                const questionInfo = curriculumData?.[questionId] || {};
                const questionTitle = questionInfo.prompt ?
                    questionInfo.prompt.substring(0, 100) + '...' :
                    questionId;

                card.innerHTML = `
                    <h4>${questionId}</h4>
                    <p style="font-size: 0.9em; color: #666;">${questionTitle}</p>
                    <p>Total responses: ${totalResponses}</p>
                    <div class="answer-distribution">
                        ${Object.entries(answers)
                            .sort((a, b) => b[1] - a[1])
                            .map(([value, count]) => {
                                const percentage = Math.round((count / totalResponses) * 100);
                                return `
                                    <div class="answer-bar">
                                        <span style="width: 40px;">${value}:</span>
                                        <div style="flex: 1; background: #e0e0e0; border-radius: 3px;">
                                            <div class="answer-bar-fill" style="width: ${percentage}%;"></div>
                                        </div>
                                        <span style="width: 80px; text-align: right;">${count} (${percentage}%)</span>
                                    </div>
                                `;
                            }).join('')}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Extract unique units and lessons from question IDs
            const units = new Set();
            const lessons = new Set();

            allData.forEach(answer => {
                const parts = answer.question_id.split('-');
                if (parts.length >= 2) {
                    units.add(parts[0]); // e.g., "U1"
                    if (parts.length >= 3) {
                        lessons.add(`${parts[0]}-${parts[1]}`); // e.g., "U1-L1"
                    }
                }
            });

            // Populate unit filter
            const unitFilter = document.getElementById('unitFilter');
            unitFilter.innerHTML = '<option value="">All Units</option>';
            Array.from(units).sort().forEach(unit => {
                unitFilter.innerHTML += `<option value="${unit}">${unit}</option>`;
            });

            // Populate lesson filter
            const lessonFilter = document.getElementById('lessonFilter');
            lessonFilter.innerHTML = '<option value="">All Lessons</option>';
            Array.from(lessons).sort().forEach(lesson => {
                lessonFilter.innerHTML += `<option value="${lesson}">${lesson}</option>`;
            });
        }

        // Filter data based on selections
        function filterData() {
            const unitFilter = document.getElementById('unitFilter').value;
            const lessonFilter = document.getElementById('lessonFilter').value;

            filteredData = allData.filter(answer => {
                if (unitFilter && !answer.question_id.startsWith(unitFilter)) {
                    return false;
                }
                if (lessonFilter && !answer.question_id.startsWith(lessonFilter)) {
                    return false;
                }
                return true;
            });

            // Re-process with filtered data
            const temp = allData;
            allData = filteredData;
            processData();
            allData = temp; // Restore original data
        }

        // Refresh data
        function refreshData() {
            const button = document.querySelector('.refresh-button');
            button.disabled = true;
            button.textContent = '‚è≥ Loading...';

            loadData().then(() => {
                button.disabled = false;
                button.textContent = 'üîÑ Refresh Data';
            }).catch(() => {
                button.disabled = false;
                button.textContent = 'üîÑ Refresh Data';
            });
        }

        // Set up real-time updates
        function setupRealtimeUpdates() {
            if (!supabase) return;

            // Subscribe to changes
            const subscription = supabase
                .channel('dashboard_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'answers' },
                    (payload) => {
                        console.log('üì® Real-time update received:', payload);
                        // Reload data when changes occur
                        loadData();
                    }
                )
                .subscribe();
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadData();

            // Set up real-time updates
            setupRealtimeUpdates();

            // Refresh data every 60 seconds
            setInterval(refreshData, 60000);
        });
    </script>
</body>
</html>